<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FloodingMap</title>

<!-- Leaflet Map CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
        font-family: Arial;
        overflow: hidden;
    }

    /* B·∫£n ƒë·ªì chi·∫øm to√†n b·ªô m√†n h√¨nh */
    #map {
        width: 100vw;
        height: 100vh;
    }

    /* --- PANEL CHI TI·∫æT --- */
    #infoPanel {
        position: fixed;
        top: 0;
        right: -400px;  /* ·∫®n panel ban ƒë·∫ßu */
        width: 400px;
        height: 100vh;
        background: #ffffff;
        border-left: 3px solid #0078ff;
        padding: 20px;
        overflow-y: auto;
        transition: 0.35s ease;
        box-shadow: -4px 0 10px rgba(0,0,0,0.2);
        z-index: 9999;
    }

    #infoPanel.active {
        right: 0;   /* Tr∆∞·ª£t ra khi click */
    }

    .close-btn {
        font-size: 18px;
        padding: 8px 12px;
        background: #ff3b3b;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        margin-bottom: 20px;
        display: inline-block;
    }

    /* Marker ƒëi·ªÉm ƒëo */
    .sensor-marker {
        width: 20px;
        height: 20px;
        background: #0090ff;
        border-radius: 50%;
        border: 2px solid white;
        cursor: pointer;
    }

</style>
</head>
<body>

<!-- B·∫£n ƒë·ªì -->
<div id="map"></div>

<!-- PANEL CHI TI·∫æT ƒêI·ªÇM ƒêO -->
<div id="infoPanel">
    <div class="close-btn" onclick="closePanel()">ƒê√≥ng</div>

    <h2 id="sensorName"></h2>
    <div id="gaugeBox"></div>
    <p id="statusText" style="font-size:16px; margin:10px 0;"></p>

    <div id="chartBox" style="margin-top:20px;"></div>
</div>

<script>
/* ==============================
   C·∫§U H√åNH ADAFRUIT IO
================================ */
const AIO_USERNAME = "quagmire_win1000";
const AIO_KEY      = "aio_mCmT98e85Vy0rNOZUDEq7aKAg77J";

/* ==============================
   DANH S√ÅCH ƒêI·ªÇM ƒêO
================================ */
const SENSORS = [
    {
        name: "ƒêi·ªÉm ƒëo 1",
        feed: "waterlevel1",
        lat: 10.75,
        lng: 106.65,
        max_level: 100,
        warning: 60,
        danger: 80
    },
    {
        name: "ƒêi·ªÉm ƒëo 2",
        feed: "waterlevel2",
        lat: 10.77,
        lng: 106.67,
        max_level: 100,
        warning: 60,
        danger: 80
    }
];

/* ==============================
   KH·ªûI T·∫†O B·∫¢N ƒê·ªí
================================ */
const map = L.map('map').setView([10.76, 106.66], 14);

// Map n·ªÅn
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

/* ==============================
   T·∫†O MARKER TR√äN MAP
================================ */
SENSORS.forEach(point => {
    const marker = L.circleMarker([point.lat, point.lng], {
        radius: 10,
        color: "#0090ff",
        fillColor: "#00aaff",
        fillOpacity: 0.8
    })
    .addTo(map)
    .on("click", () => openSensorPanel(point));
});

/* ==============================
   H√ÄM L·∫§Y D·ªÆ LI·ªÜU ADAFRUIT
================================ */
async function fetchData(feed, limit = 1) {
    const url = `https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds/${feed}/data?limit=${limit}&x-aio-key=${AIO_KEY}`;
    const res = await fetch(url);
    const data = await res.json();
    return data;
}

/* ==============================
   H√ÄM M·ªû PANEL CHI TI·∫æT
================================ */
async function openSensorPanel(point) {
    document.getElementById("infoPanel").classList.add("active");
    document.getElementById("sensorName").innerText = point.name;

    const latest = await fetchData(point.feed, 1);
    const value = parseFloat(latest[0].value);

    renderGauge(point, value);
    renderStatus(point, value);

    const history = await fetchData(point.feed, 20);
    renderChart(history);
}

/* ===============================
   ƒê√ìNG PANEL
================================ */
function closePanel() {
    document.getElementById("infoPanel").classList.remove("active");
}

/* ==============================
   RENDER GAUGE
================================ */
function renderGauge(point, value) {
    const percent = Math.min(100, Math.round(value / point.max_level * 100));

    document.getElementById("gaugeBox").innerHTML = `
        <div style="text-align:center; margin-top:15px;">
            <h3>M·ª±c n∆∞·ªõc hi·ªán t·∫°i: ${value} cm</h3>
            <h2 style="color:#0078ff; font-size:40px">${percent}%</h2>
        </div>
    `;
}

/* ==============================
   TR·∫†NG TH√ÅI C·∫¢NH B√ÅO
================================ */
function renderStatus(point, value) {
    let txt = "";
    let color = "";

    if (value >= point.danger) {
        txt = "‚ö†Ô∏è Nguy hi·ªÉm ‚Äì m·ª©c n∆∞·ªõc v∆∞·ª£t ng∆∞·ª°ng!";
        color = "red";
    } else if (value >= point.warning) {
        txt = "üü° C·∫£nh b√°o ‚Äì m·ª©c n∆∞·ªõc tƒÉng cao.";
        color = "orange";
    } else {
        txt = "üü¢ An to√†n ‚Äì m·ª±c n∆∞·ªõc b√¨nh th∆∞·ªùng.";
        color = "green";
    }

    document.getElementById("statusText").innerHTML =
        `<span style="color:${color}; font-weight:bold;">${txt}</span>`;
}

/* ==============================
   BI·ªÇU ƒê·ªí L·ªäCH S·ª¨
================================ */
function renderChart(history) {
    const values = history.map(d => parseFloat(d.value)).reverse();
    const times = history.map(d => d.created_at).reverse();

    document.getElementById("chartBox").innerHTML = "";

    new ApexCharts(document.getElementById("chartBox"), {
        chart: { type: "line", height: 260 },
        series: [{ name: "M·ª±c n∆∞·ªõc", data: values }],
        xaxis: { categories: times },
        stroke: { width: 3 },
        colors: ["#0078ff"]
    }).render();
}

</script>
</body>
</html>
