<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B·∫£n ƒë·ªì gi√°m s√°t m·ª±c n∆∞·ªõc ‚Äì ƒê√† N·∫µng</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    body { margin:0; padding:0; font-family:Arial; }

    #map {
        width: 100vw;
        height: 100vh;
    }

    /* ========== SIDEBAR ========== */
    #sidebar {
        position: fixed;
        top: 0;
        right: -420px;
        width: 420px;
        height: 100vh;
        background: #ffffff;
        border-left: 3px solid #0078ff;
        box-shadow: -4px 0 25px rgba(0,0,0,0.15);
        transition: 0.35s;
        padding: 0;
        z-index: 9999;
        display: flex;
        flex-direction: column;
    }

    #sidebar.active {
        right: 0;
    }

    /* Header */
    #sidebarHeader {
        background: linear-gradient(135deg, #0078ff, #00a6ff);
        color: white;
        padding: 16px;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #closeBtn {
        cursor: pointer;
        font-size: 22px;
        padding: 2px 8px;
        background: rgba(255,255,255,0.3);
        border-radius: 4px;
    }

    /* N·ªôi dung */
    #sidebarContent {
        padding: 20px;
        overflow-y: auto;
    }

    /* N√∫t toggle sidebar */
    #toggleSidebar {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #0078ff;
        color: white;
        padding: 14px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        font-size: 20px;
        transition: 0.25s;
    }

    #toggleSidebar:hover {
        transform: scale(1.1);
    }

    /* T√¨m ki·∫øm */
    #searchBox {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 10000;
    }

    #searchInput {
        width: 260px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 2px solid #0078ff;
        font-size: 16px;
        outline: none;
    }

</style>
</head>
<body>

<!-- N√∫t toggle -->
<div id="toggleSidebar">‚ò∞</div>

<!-- √î t√¨m ki·∫øm -->
<div id="searchBox">
    <input id="searchInput" placeholder="T√¨m ƒëi·ªÉm ƒëo..." />
</div>

<!-- B·∫£n ƒë·ªì -->
<div id="map"></div>

<!-- Sidebar -->
<div id="sidebar">
    <div id="sidebarHeader">
        Chi ti·∫øt ƒëi·ªÉm ƒëo
        <span id="closeBtn">‚úï</span>
    </div>

    <div id="sidebarContent">
        <h2 id="sensorName"></h2>
        <div id="gaugeBox"></div>
        <p id="statusText"></p>
        <div id="chartBox" style="margin-top:25px;"></div>
    </div>
</div>

<script>
/* ==============================
   C·∫§U H√åNH ADAFRUIT IO
================================ */
const AIO_USERNAME = "quagmire_win1000";
const AIO_KEY      = "aio_wrba09jowDt4fTmz8xGvk1QSu9nM";

/* ==============================
   DANH S√ÅCH ƒêI·ªÇM ƒêO
================================ */
const SENSORS = [
    {
        name: "C·∫ßu R·ªìng",
        feed: "mucnuoc1",
        lat: 16.0605,
        lng: 108.2237,
        max_level: 100,
        warning: 60,
        danger: 85
    },
    {
        name: "C·∫ßu S√¥ng H√†n",
        feed: "mucnuoc2",
        lat: 16.0678,
        lng: 108.2301,
        max_level: 100,
        warning: 60,
        danger: 85
    },
    {
        name: "Ng√£ ba Hu·∫ø",
        feed: "mucnuoc3",
        lat: 16.0543,
        lng: 108.1901,
        max_level: 100,
        warning: 60,
        danger: 85
    }
];

/* ==============================
   MAP ƒê√Ä N·∫¥NG
================================ */
const map = L.map('map').setView([16.0678, 108.2200], 13);

L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

/* ==============================
   T·∫†O MARKER
================================ */
SENSORS.forEach(point => {
    L.circleMarker([point.lat, point.lng], {
        radius: 10,
        color: "#0078ff",
        fillColor: "#00a6ff",
        fillOpacity: 0.9
    })
    .addTo(map)
    .on("click", () => openSensor(point));
});

/* ==============================
   FETCH DATA
================================ */
async function getData(feed, limit = 1) {
    const url = `https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds/${feed}/data?limit=${limit}&x-aio-key=${AIO_KEY}`;
    const res = await fetch(url);
    return await res.json();
}

/* ==============================
   M·ªû SIDEBAR KHI CLICK MARKER
================================ */
async function openSensor(point) {
    toggleSidebar(true);

    document.getElementById("sensorName").innerText = point.name;

    const last = await getData(point.feed, 1);
    const val = parseFloat(last[0].value);

    renderGauge(point, val);
    renderStatus(point, val);

    const history = await getData(point.feed, 15);
    renderChart(history);
}

/* ==============================
   SIDEBAR TOGGLE
================================ */
const sidebar = document.getElementById("sidebar");
const toggleBtn = document.getElementById("toggleSidebar");
const closeBtn = document.getElementById("closeBtn");

toggleBtn.onclick = () => toggleSidebar();
closeBtn.onclick = () => toggleSidebar(false);

function toggleSidebar(forceOpen = null) {
    if (forceOpen === true) {
        sidebar.classList.add("active");
        return;
    }
    if (forceOpen === false) {
        sidebar.classList.remove("active");
        return;
    }
    sidebar.classList.toggle("active");
}

/* ==============================
   GAUGE
================================ */
function renderGauge(point, value) {
    const percent = Math.round(value / point.max_level * 100);
    document.getElementById("gaugeBox").innerHTML = `
        <h3>M·ª±c n∆∞·ªõc: ${value} cm</h3>
        <h1 style="color:#0078ff; font-size:40px">${percent}%</h1>
    `;
}

/* ==============================
   STATUS
================================ */
function renderStatus(point, value) {
    let text, color;

    if (value >= point.danger) { text = "‚ö†Ô∏è Nguy hi·ªÉm"; color = "red"; }
    else if (value >= point.warning) { text = "üü° C·∫£nh b√°o"; color = "orange"; }
    else { text = "üü¢ An to√†n"; color = "green"; }

    document.getElementById("statusText").innerHTML =
        `<span style="color:${color}; font-size:18px; font-weight:bold;">${text}</span>`;
}

/* ==============================
   BI·ªÇU ƒê·ªí
================================ */
function renderChart(history) {
    const values = history.map(d => parseFloat(d.value)).reverse();
    const times = history.map(d => d.created_at.slice(11,19)).reverse();

    document.getElementById("chartBox").innerHTML = "";

    new ApexCharts(document.getElementById("chartBox"), {
        chart: { type: "line", height: 260 },
        series: [{ name: "M·ª±c n∆∞·ªõc", data: values }],
        xaxis: { categories: times },
        stroke: { width: 3 }
    }).render();
}

/* ==============================
   T√åM KI·∫æM ƒêI·ªÇM ƒêO
================================ */
document.getElementById("searchInput").addEventListener("input", function () {
    const keyword = this.value.toLowerCase();

    const found = SENSORS.find(s => s.name.toLowerCase().includes(keyword));
    if (!found) return;

    map.setView([found.lat, found.lng], 15);
    openSensor(found);
});
</script>

</body>
</html>
