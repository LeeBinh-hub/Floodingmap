<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Floodingmap</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- ApexCharts -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
    body { margin:0; padding:0; font-family:Arial; }
    #map { width: 100vw; height: 100vh; }

    /* ========== SIDEBAR ========== */
    #sidebar {
        position: fixed;
        top: 0;
        right: -420px;
        width: 420px;
        height: 100vh;
        background: #ffffff;
        border-left: 3px solid #0078ff;
        box-shadow: -4px 0 25px rgba(0,0,0,0.15);
        transition: 0.35s;
        padding: 0;
        z-index: 9999;
        display: flex;
        flex-direction: column;
    }
    #sidebar.active { right: 0; }

    #sidebarHeader {
        background: linear-gradient(135deg, #0078ff, #00a6ff);
        color: white;
        padding: 16px;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #closeBtn {
        cursor: pointer;
        font-size: 22px;
        padding: 2px 8px;
        background: rgba(255,255,255,0.3);
        border-radius: 4px;
    }

    #sidebarContent {
        padding: 20px;
        overflow-y: auto;
    }

    #toggleSidebar {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #0078ff;
        color: white;
        padding: 14px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 10000;
        box-shadow: 0 4px 10px rgba(0,0,0,0.25);
        font-size: 20px;
        transition: 0.25s;
    }
    #toggleSidebar:hover { transform: scale(1.1); }

    #searchBox {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 10000;
    }
    #searchInput {
        width: 260px;
        padding: 10px 14px;
        border-radius: 10px;
        border: 2px solid #0078ff;
        font-size: 16px;
        outline: none;
    }
</style>
</head>
<body>

<div id="toggleSidebar">â˜°</div>

<div id="searchBox">
    <input id="searchInput" placeholder="TÃ¬m Ä‘iá»ƒm Ä‘o..." />
</div>

<div id="map"></div>

<div id="sidebar">
    <div id="sidebarHeader">
        Chi tiáº¿t Ä‘iá»ƒm Ä‘o
        <span id="closeBtn">âœ•</span>
    </div>

    <div id="sidebarContent">
        <h2 id="sensorName"></h2>
        <div id="gaugeBox"></div>
        <p id="statusText"></p>
        <div id="chartBox" style="margin-top:25px;"></div>
    </div>
</div>

<script>
/* ==============================
   Cáº¤U HÃŒNH ADAFRUIT IO
================================ */
const AIO_USERNAME = "quagmire_win1000";
const AIO_KEY      = "aio_wrba09jowDt4fTmz8xGvk1QSu9nM";

/* ==============================
   DANH SÃCH ÄIá»‚M ÄO
================================ */
const SENSORS = [
    { name: "Cáº§u Rá»“ng", feed: "iotproject.mucnuoc1", lat: 16.0605, lng: 108.2237, max_level: 100, warning: 60, danger: 85 },
    { name: "Cáº§u SÃ´ng HÃ n", feed: "iotproject.mucnuoc2", lat: 16.0678, lng: 108.2301, max_level: 100, warning: 60, danger: 85 }
];

/* ==============================
   MAP ÄÃ€ Náº´NG
================================ */
const map = L.map('map').setView([16.0678, 108.2200], 13);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

/* ==============================
   MARKER & VÃ’NG TRÃ’N áº¢NH HÆ¯á»žNG
================================ */
let influenceLayers = {}; // lÆ°u cÃ¡c vÃ²ng trÃ²n gradient

SENSORS.forEach(point => {
    const marker = L.circleMarker([point.lat, point.lng], {
        radius: 10,
        color: "#0078ff",
        fillColor: "#00a6ff",
        fillOpacity: 0.9
    }).addTo(map);

    marker.on("click", () => openSensor(point));
});

/* ==============================
   FETCH DATA
================================ */
async function getData(feed, limit = 1) {
    const url = `https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds/${feed}/data?limit=${limit}&x-aio-key=${AIO_KEY}`;
    const res = await fetch(url);
    return await res.json();
}

/* ==============================
   Má»ž SIDEBAR KHI CLICK MARKER
================================ */
async function openSensor(point) {
    toggleSidebar(true);
    document.getElementById("sensorName").innerText = point.name;

    const last = await getData(point.feed, 1);
    const val = parseFloat(last[0].value);

    renderGauge(point, val);
    renderStatus(point, val);
    renderInfluence(point, val); // âœ… gradient mÆ°á»£t

    const history = await getData(point.feed, 15);
    renderChart(history);
}

/* ==============================
   VÃ’NG TRÃ’N áº¢NH HÆ¯á»žNG GRADIENT
================================ */
function renderInfluence(point, value) {
    // XÃ³a vÃ²ng trÃ²n cÅ© náº¿u cÃ³
    if (influenceLayers[point.feed]) {
        influenceLayers[point.feed].forEach(c => map.removeLayer(c));
    }

    const layers = [];
    const steps = 8; // sá»‘ vÃ²ng trÃ²n mÆ°á»£t hÆ¡n
    const maxRadius = 100 + (value / point.max_level) * 400; // bÃ¡n kÃ­nh tá»‘i Ä‘a

    for (let i = 1; i <= steps; i++) {
        const radius = (i / steps) * maxRadius;
        const opacity = 0.4 * (1 - i / steps); // má» dáº§n

        // mÃ u gradient tá»« xanh â†’ vÃ ng â†’ Ä‘á» theo má»±c nÆ°á»›c
        let color;
        if (value >= point.danger) color = `rgba(255,0,0,${opacity})`;
        else if (value >= point.warning) color = `rgba(255,165,0,${opacity})`;
        else color = `rgba(0,128,255,${opacity})`;

        const circle = L.circle([point.lat, point.lng], {
            radius: radius,
            color: color,
            fillColor: color,
            fillOpacity: opacity,
            weight: 1
        }).addTo(map);

        layers.push(circle);
    }

    influenceLayers[point.feed] = layers;
}

/* ==============================
   SIDEBAR TOGGLE
================================ */
const sidebar = document.getElementById("sidebar");
const toggleBtn = document.getElementById("toggleSidebar");
const closeBtn = document.getElementById("closeBtn");

toggleBtn.onclick = () => toggleSidebar();
closeBtn.onclick = () => toggleSidebar(false);

function toggleSidebar(forceOpen = null) {
    if (forceOpen === true) { sidebar.classList.add("active"); return; }
    if (forceOpen === false) { sidebar.classList.remove("active"); return; }
    sidebar.classList.toggle("active");
}

/* ==============================
   GAUGE
================================ */
function renderGauge(point, value) {
    const percent = Math.round(value / point.max_level * 100);
    document.getElementById("gaugeBox").innerHTML = `
        <h3>Má»±c nÆ°á»›c: ${value} cm</h3>
        <h1 style="color:#0078ff; font-size:40px">${percent}%</h1>
    `;
}

/* ==============================
   STATUS
================================ */
function renderStatus(point, value) {
    let text, color;
    if (value >= point.danger) { text = "âš ï¸ Nguy hiá»ƒm"; color = "red"; }
    else if (value >= point.warning) { text = "ðŸŸ¡ Cáº£nh bÃ¡o"; color = "orange"; }
    else { text = "ðŸŸ¢ An toÃ n"; color = "green"; }

    document.getElementById("statusText").innerHTML =
        `<span style="color:${color}; font-size:18px; font-weight:bold;">${text}</span>`;
}

/* ==============================
   BIá»‚U Äá»’
================================ */
function renderChart(history) {
    const values = history.map(d => parseFloat(d.value)).reverse();
    const times = history.map(d => d.created_at.slice(11,19)).reverse();

    document.getElementById("chartBox").innerHTML = "";

    new ApexCharts(document.getElementById("chartBox"), {
        chart: { type: "line", height: 260 },
        series: [{ name: "Má»±c nÆ°á»›c", data: values }],
        xaxis: { categories: times },
        stroke: { width: 3 }
    }).render();
}

/* ==============================
   TÃŒM KIáº¾M ÄIá»‚M ÄO
================================ */
document.getElementById("searchInput").addEventListener("input", function () {
    const keyword = this.value.toLowerCase();
    const found = SENSORS.find(s => s.name.toLowerCase().includes(keyword));
    if (!found) return;

    map.setView([found.lat, found.lng], 15);
    openSensor(found);
});
</script>

</body>
</html>
