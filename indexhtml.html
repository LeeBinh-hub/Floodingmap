<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Cảnh báo Lũ lụt IoT - Dashboard Map</title>
    <!-- Tải Tailwind CSS cho giao diện đẹp và đáp ứng -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Tải Leaflet CSS cho bản đồ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SVSLvcEFoWc68aeY="
        crossorigin=""/>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tông màu tối (Dark Mode) */
            min-height: 100vh;
        }
        #map {
            height: 70vh; 
            width: 100%;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
            border: 1px solid #374151; 
            /* Đặt nền đen cho Map khi không có Tile Layer (Chỉ dùng Image Overlay) */
            background-color: #000000; 
        }
        .data-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background-color: #1f2937; 
            color: #f3f4f6;
            border-radius: 0.75rem;
        }
        .config-section, .chart-section {
            background-color: #1f2937;
            border-radius: 0.75rem;
            border: 1px solid #374151;
        }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip {
            background-color: #1f2937 !important;
            color: #f3f4f6;
        }
        .leaflet-popup-content a {
            color: #6366f1;
        }
        /* Chiều cao của khu vực Sidebar bằng với Map trên Desktop */
        .sidebar-container {
             min-height: 70vh; /* Bằng với chiều cao của #map */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- Header -->
        <header class="mb-8 border-b border-gray-700 pb-4">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-extrabold text-indigo-400">
                    <svg class="inline-block w-8 h-8 mr-2 text-red-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4l-2 2"/></svg>
                    HỆ THỐNG CẢNH BÁO MỨC NƯỚC SỚM (FWS)
                </h1>
                <p id="last-updated" class="text-sm font-medium text-gray-400">Cập nhật lần cuối: Chưa có dữ liệu</p>
            </div>
        </header>
        
        <!-- GLOBAL ALERT BAR -->
        <div id="global-alert" class="hidden bg-red-800 p-4 rounded-lg mb-6 shadow-2xl text-white font-bold text-center">
            <svg class="inline w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h18.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <span id="alert-message"></span>
        </div>

        <!-- MAIN LAYOUT: MAP and DATA CARDS (BỐ CỤC MỚI) -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Cột 1 & 2: Bản đồ (Chiếm 2/3 không gian) -->
            <div class="lg:col-span-2">
                <div id="map"></div>
            </div>

            <!-- Cột 3: Sidebar (Chiếm 1/3 không gian) -->
            <div class="lg:col-span-1 space-y-6 sidebar-container">
                
                <!-- Nhóm 1: Thẻ Dữ liệu Chính (Trạng thái và Cảnh báo) -->
                <!-- Sử dụng grid để đặt 2 thẻ cạnh nhau trên màn hình vừa và lớn -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-1 gap-6"> 
                    
                    <!-- Thẻ Trạng thái và Kết nối -->
                    <div id="status-card" class="data-card p-4 shadow-xl border-l-4 border-indigo-500">
                        <div class="flex items-center space-x-3">
                            <svg class="w-6 h-6 text-indigo-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3H6a2 2 0 0 0-2 2v2"/><path d="M14 3h4a2 2 0 0 1 2 2v2"/><path d="M14 21h4a2 2 0 0 0 2-2v-2"/><path d="M10 21H6a2 2 0 0 1-2-2v-2"/><path d="M8 12h8"/><path d="M12 2v20"/></svg>
                            <div>
                                <p class="text-sm font-medium text-gray-400">Trạng thái Kết nối</p>
                                <p id="connection-status" class="text-xl font-extrabold mt-1 text-red-500">Đang Ngắt Kết Nối</p>
                            </div>
                        </div>
                    </div>

                    <!-- Thẻ Cảnh báo Trạm Nóng nhất -->
                    <div id="hot-station-card" class="data-card p-4 shadow-xl border-l-4 border-red-500">
                        <div class="flex items-center space-x-3">
                            <svg class="w-6 h-6 text-red-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.76l1.32-9.14A2 2 0 0 0 14 9v0z"/></svg>
                            <div>
                                <p class="text-sm font-medium text-gray-400">Mực nước CAO NHẤT</p>
                                <p id="highest-station-name" class="text-base font-extrabold mt-1 text-red-300">N/A</p>
                                <p id="highest-water-level" class="text-2xl font-extrabold mt-1 text-red-500">0.0 cm</p>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- Khu vực Cấu hình (Tách biệt và chi tiết hơn) -->
                <div class="p-6 config-section shadow-xl">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-400 border-b border-gray-700 pb-2">Cấu hình & Kết nối IoT</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="aio-username" class="block text-sm font-medium text-gray-300">AIO Username:</label>
                            <input type="text" id="aio-username" value="qua_nghe_win_1000" class="mt-1 block w-full rounded-md shadow-sm p-2 border border-gray-600 bg-gray-800 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="aio-key" class="block text-sm font-medium text-gray-300">AIO Key:</label>
                            <input type="password" id="aio-key" value="aio_mcN9B6SVJy8rN0ZD0ED7AKAg773" class="mt-1 block w-full rounded-md shadow-sm p-2 border border-gray-600 bg-gray-800 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                         <div>
                            <label for="mqtt-feed" class="block text-sm font-medium text-gray-300">Tên Feed Dữ liệu JSON:</label>
                            <input type="text" id="mqtt-feed" value="flood_monitor" class="mt-1 block w-full rounded-md shadow-sm p-2 border border-gray-600 bg-gray-800 text-gray-100 focus:ring-indigo-500 focus:border-indigo-500">
                            <p class="text-xs text-gray-500 mt-1">ESP32 gửi JSON tới feed này.</p>
                        </div>
                        <button onclick="reconnectMQTT()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                            Kết nối lại MQTT
                        </button>
                    </div>
                </div>

            </div>
        </main>
        
        <!-- CHART SECTION (Lịch sử - Luôn Full Width) -->
        <section id="chart-section" class="mt-8 p-6 chart-section shadow-xl">
            <h2 class="text-xl font-semibold mb-4 text-teal-400">
                 <svg class="inline w-6 h-6 mr-2" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
                Lịch sử Mức Nước - Trạm <span id="chart-station-name" class="font-extrabold">Chưa chọn</span> (24h gần nhất)
            </h2>
            <div class="relative h-96">
                <canvas id="waterLevelChart"></canvas>
            </div>
        </section>

    </div>

    <!-- Tải Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6cT5hYy+5r6nQ/cQp8n5vJ/L2sS5iPjJ1zP0Q6Sg="
        crossorigin=""></script>
    <!-- Tải Paho MQTT JavaScript Client (sử dụng WebSockets) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.min.js"></script>
    <!-- Tải Chart.js cho biểu đồ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    
    <script>
        // Thiết lập biến toàn cục
        let client;
        let map;
        const stationMarkers = {};
        const AIO_SERVER = 'io.adafruit.com';
        const AIO_PORT_WS = 443; 
        let waterLevelChart; // Biến giữ đối tượng Chart.js

        // Dữ liệu trạm cố định
        const FIXED_STATIONS = [
            { id: 'DN_001', name: 'Trạm Cầu Sông Hàn', lat: 16.0620, lon: 108.2238, currentLevel: 0, marker: null, color: '#10b981' },
            { id: 'DN_002', name: 'Trạm An Hải Đông', lat: 16.0592, lon: 108.2325, currentLevel: 0, marker: null, color: '#10b981' },
            { id: 'QN_003', name: 'Trạm Hòa Khánh', lat: 16.0825, lon: 108.1500, currentLevel: 0, marker: null, color: '#10b981' },
        ];


        // Tải các giá trị cấu hình từ input
        function getConfig() {
            return {
                username: document.getElementById('aio-username').value,
                key: document.getElementById('aio-key').value,
                mqttFeed: document.getElementById('mqtt-feed').value,
            };
        }

        // ---------- HÀM XÁC ĐỊNH STYLE VÒNG TRÒN (GRADIENT MÀU) ----------
        function getWaterLevelStyle(level) {
            let color, radius, alertText = null;

            if (level <= 50) { // An toàn: Dưới 50 cm
                color = '#10b981'; // Teal-500 (Xanh lá)
                radius = 300; 
                alertText = 'An toàn';
            } else if (level <= 100) { // Cảnh báo: 51 - 100 cm
                color = '#fbbf24'; // Amber-400 (Vàng)
                radius = 600; 
                alertText = 'Cảnh báo cấp 1';
            } else { // Nguy hiểm: Trên 100 cm
                color = '#ef4444'; // Red-500 (Đỏ)
                radius = 1000; 
                alertText = 'NGUY HIỂM CẤP 2';
            }
            
            return {
                color: color,
                fillColor: color,
                fillOpacity: 0.5,
                radius: radius, 
                alert: alertText
            };
        }

        // ---------- KHỞI TẠO BẢN ĐỒ LEAFLET ----------
        function initMap() {
            // Khởi tạo bản đồ với vị trí tập trung mặc định
            map = L.map('map').setView([16.06, 108.22], 13); 

            // =========================================================================
            // *** PHẦN TÙY CHỈNH: THÊM BẢN ĐỒ CỦA BẠN DƯỚI DẠNG LỚP PHỦ HÌNH ẢNH ***
            // =========================================================================
            
            // 1. THAY THẾ URL NÀY BẰNG URL HÌNH ẢNH BẢN ĐỒ TÙY CHỈNH CỦA BẠN (Ví dụ: từ Google Drive, Dropbox, hoặc một server ảnh)
            const customImageUrl = 'https://placehold.co/1000x800/222222/ffffff?text=CUSTOM+FLOOD+MAP+HERE'; 
            
            // 2. CẬP NHẬT TỌA ĐỘ GÓC (BOUNDS) CHO HÌNH ẢNH
            // Tọa độ này phải khớp với 4 góc thực tế của hình ảnh trên bản đồ.
            // Ví dụ này là khu vực Đà Nẵng:
            const imageBounds = [
                [16.03, 108.18], // Góc Tây Nam (South West - lat thấp nhất, lon thấp nhất)
                [16.09, 108.26]  // Góc Đông Bắc (North East - lat cao nhất, lon cao nhất)
            ]; 
            
            // Thêm lớp phủ hình ảnh
            L.imageOverlay(customImageUrl, imageBounds).addTo(map);
            
            // Đảm bảo Map tập trung vào khu vực của Image Overlay
            map.fitBounds(imageBounds); 
            // =========================================================================
            // *** XÓA LỚP OSM MẶC ĐỊNH (để chỉ dùng bản đồ tùy chỉnh của bạn) ***
            // =========================================================================


            // Khởi tạo các Marker cố định ban đầu
            FIXED_STATIONS.forEach(station => {
                const style = getWaterLevelStyle(station.currentLevel);
                
                const circle = L.circle([station.lat, station.lon], style).addTo(map);
                
                const popupContent = `
                    <h3 class="font-bold text-lg text-indigo-400">${station.name} (${station.id})</h3>
                    <p class="text-sm">Vị trí: ${station.lat.toFixed(4)}, ${station.lon.toFixed(4)}</p>
                    <p class="text-xl font-extrabold mt-2" style="color:${style.color};">Mức Nước: 0.0 cm</p>
                    <p class="text-sm font-semibold">Trạng thái: ${style.alert}</p>
                    <button class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs px-2 py-1 rounded mt-2" onclick="fetchHistory('${station.id}')">Xem Biểu đồ 24h</button>
                `;
                
                circle.bindPopup(popupContent);
                
                stationMarkers[station.id] = {
                    circle: circle,
                    data: station,
                    fixedData: FIXED_STATIONS.find(s => s.id === station.id)
                };
            });
        }
        
        // ---------- HÀM CẬP NHẬT TRẠM ĐO ----------
        function updateStation(data) {
            const { stationId, lat, lon, waterLevel } = data;
            
            if (!stationMarkers[stationId]) {
                console.warn(`Station ID ${stationId} not found in FIXED_STATIONS. Ignoring or treating as transient.`);
                return;
            }

            const marker = stationMarkers[stationId].circle;
            const stationData = stationMarkers[stationId].fixedData;
            
            const style = getWaterLevelStyle(waterLevel);
            
            // 1. Cập nhật vị trí và style
            marker.setLatLng([lat, lon]);
            marker.setStyle(style);
            marker.setRadius(style.radius);
            stationMarkers[stationId].data.currentLevel = waterLevel; 
            
            // 2. Cập nhật Popup Content
            const timestamp = new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit', second:'2-digit'});
            
            const popupContent = `
                <h3 class="font-bold text-lg text-indigo-400">${stationData.name} (${stationId})</h3>
                <p class="text-sm">Vị trí: ${lat.toFixed(4)}, ${lon.toFixed(4)}</p>
                <p class="text-xl font-extrabold mt-2" style="color:${style.color};">Mức Nước: ${waterLevel.toFixed(1)} cm</p>
                <p class="text-sm font-semibold">Trạng thái: ${style.alert}</p>
                <p class="text-xs text-gray-400 mt-2">Cập nhật: ${timestamp}</p>
                 <button class="bg-indigo-500 hover:bg-indigo-600 text-white text-xs px-2 py-1 rounded mt-2" onclick="fetchHistory('${stationId}')">Xem Biểu đồ 24h</button>
            `;
            marker.setPopupContent(popupContent);
            
            // 3. Cập nhật thanh cảnh báo chung và thẻ nóng nhất
            updateAlertsAndHotStation(timestamp);
            
            // 4. Tự động tải lịch sử cho trạm vừa cập nhật
            fetchHistory(stationId);
        }

        // ---------- HÀM VẼ BIỂU ĐỒ LỊCH SỬ (CHART.JS) ----------
        function renderChart(stationName, labels, data) {
            document.getElementById('chart-station-name').textContent = stationName;
            const ctx = document.getElementById('waterLevelChart').getContext('2d');

            if (waterLevelChart) {
                waterLevelChart.destroy(); // Hủy biểu đồ cũ nếu có
            }

            waterLevelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Mức Nước (cm)',
                        data: data,
                        borderColor: '#38bdf8', // Sky-400
                        backgroundColor: 'rgba(56, 189, 248, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: { display: true, text: 'Mức Nước (cm)', color: '#9ca3af' },
                            grid: { color: '#374151' },
                            ticks: { color: '#e5e7eb' }
                        },
                        x: {
                            title: { display: true, text: 'Thời gian', color: '#9ca3af' },
                            grid: { color: '#374151' },
                            ticks: { color: '#e5e7eb' }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        title: {
                            display: true,
                            text: `Lịch sử Mức Nước - ${stationName}`,
                            color: '#e5e7eb'
                        }
                    }
                }
            });
        }
        
        // ---------- HÀM GỌI API LẤY LỊCH SỬ TỪ ADAFRUIT IO ----------
        async function fetchHistory(stationId) {
            const config = getConfig();
            const station = FIXED_STATIONS.find(s => s.id === stationId);
            
            if (!station) return;
            
            const url = `https://${AIO_SERVER}/api/v2/${config.username}/feeds/${config.mqttFeed}/data?limit=100`; // Lấy 100 điểm gần nhất
            
            document.getElementById('chart-station-name').textContent = `${station.name} (Đang tải...)`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'X-AIO-Key': config.key
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Lọc dữ liệu chỉ lấy của trạm hiện tại và parse JSON
                const filteredData = data
                    .map(item => {
                        try {
                            // Chắc chắn rằng item.value là JSON hợp lệ trước khi parse
                            const valueObj = JSON.parse(item.value); 
                            return {
                                time: new Date(item.created_at),
                                value: valueObj
                            };
                        } catch (e) {
                            return null;
                        }
                    })
                    .filter(item => item && item.value.stationId === stationId)
                    .reverse(); // Đảo ngược để dữ liệu mới nhất ở cuối

                if (filteredData.length === 0) {
                     document.getElementById('chart-station-name').textContent = `${station.name} (Chưa có dữ liệu)`;
                     return;
                }

                const labels = filteredData.map(item => item.time.toLocaleTimeString('vi-VN'));
                const values = filteredData.map(item => item.value.waterLevel);

                renderChart(station.name, labels, values);

            } catch (error) {
                console.error("Lỗi khi tải lịch sử từ Adafruit IO:", error);
                document.getElementById('chart-station-name').textContent = `${station.name} (Lỗi tải dữ liệu)`;
            }
        }

        // ---------- HÀM CẬP NHẬT CẢNH BÁO TỔNG QUAN (KHÔNG THAY ĐỔI) ----------
        function updateAlertsAndHotStation(timestamp) {
            let highestLevel = -1;
            let highestStationName = 'N/A';
            let alertCount = 0;

            Object.keys(stationMarkers).forEach(id => {
                const data = stationMarkers[id].data;
                
                if (data.currentLevel > highestLevel) {
                    highestLevel = data.currentLevel;
                    highestStationName = stationMarkers[id].fixedData.name;
                }
                
                if (data.currentLevel > 100) { 
                    alertCount++;
                }
            });

            document.getElementById('highest-station-name').textContent = highestStationName;
            document.getElementById('highest-water-level').textContent = `${highestLevel.toFixed(1)} cm`;
            
            const alertBar = document.getElementById('global-alert');
            const alertMsg = document.getElementById('alert-message');

            if (alertCount > 0) {
                alertBar.classList.remove('hidden', 'bg-yellow-700');
                alertBar.classList.add('bg-red-800');
                alertMsg.textContent = `⚠️ ĐÃ PHÁT HIỆN ${alertCount} TRẠM Ở MỨC NGUY HIỂM CẤP 2! Hành động ngay!`;
            } else if (highestLevel > 50) {
                 alertBar.classList.remove('hidden', 'bg-red-800');
                 alertBar.classList.add('bg-yellow-700');
                 alertMsg.textContent = `LƯU Ý: Mực nước cao nhất là ${highestLevel.toFixed(1)} cm tại ${highestStationName} (Cảnh báo cấp 1).`;
            } else {
                alertBar.classList.add('hidden');
                alertBar.classList.remove('bg-yellow-700');
                alertBar.classList.add('bg-red-800'); 
            }

            document.getElementById('last-updated').textContent = `Cập nhật lần cuối: ${timestamp}`;
        }


        // ---------- CÁC HÀM XỬ LÝ KẾT NỐI MQTT (KHÔNG THAY ĐỔI) ----------
        
        function onConnect() {
            const config = getConfig();
            document.getElementById('connection-status').textContent = "ĐÃ KẾT NỐI (Hoạt động)";
            document.getElementById('connection-status').classList.remove('text-red-500', 'text-yellow-500');
            document.getElementById('connection-status').classList.add('text-green-500');

            client.subscribe(config.username + '/feeds/' + config.mqttFeed, { qos: 0 });
        }

        function onConnectionLost(responseObject) {
            document.getElementById('connection-status').textContent = "MẤT KẾT NỐI (Đang thử lại...)";
            document.getElementById('connection-status').classList.remove('text-green-500');
            document.getElementById('connection-status').classList.add('text-red-500');
            setTimeout(connectMQTT, 5000); 
        }

        function onMessageArrived(message) {
            const payload = message.payloadString;
            
            try {
                const data = JSON.parse(payload);
                if (data.stationId && typeof data.waterLevel === 'number' && typeof data.lat === 'number' && typeof data.lon === 'number') {
                    updateStation(data);
                } else {
                    console.error("Payload JSON thiếu hoặc sai định dạng: ", data);
                }
            } catch (e) {
                console.error("Lỗi Parsing JSON từ MQTT:", e, payload);
            }
        }
        
        function connectMQTT() {
            const config = getConfig();
            const clientID = `flood_map_client_${Math.random().toString(16).substr(2, 8)}`; 

            document.getElementById('connection-status').textContent = "Đang Kết Nối...";
            document.getElementById('connection-status').classList.remove('text-green-500', 'text-red-500');
            document.getElementById('connection-status').classList.add('text-yellow-500');
            
            client = new Paho.MQTT.Client(AIO_SERVER, AIO_PORT_WS, "/mqtt", clientID); 

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;

            const options = {
                useSSL: true, 
                userName: config.username,
                password: config.key,
                cleanSession: true,
                onSuccess: onConnect,
                onFailure: (response) => {
                    document.getElementById('connection-status').textContent = "KẾT NỐI THẤT BẠI";
                    document.getElementById('connection-status').classList.remove('text-green-500', 'text-yellow-500');
                    document.getElementById('connection-status').classList.add('text-red-500');
                    console.error("Kết nối thất bại: " + response.errorMessage);
                }
            };
            
            client.connect(options);
        }

        function reconnectMQTT() {
            if (client && client.isConnected()) {
                client.disconnect();
                setTimeout(connectMQTT, 1000); 
            } else {
                connectMQTT();
            }
        }

        // Khởi tạo khi trang web tải xong
        window.onload = function() {
            initMap();
            connectMQTT();
        };

    </script>
</body>
</html>